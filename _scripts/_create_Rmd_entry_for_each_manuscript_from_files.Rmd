---
output: html_document
---

# Grab meta data
```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(tidyverse)
library(here)
library(glue)

text_meta <- read_csv(here("static", "manuscripts", "manuscript_meta.csv")) %>% 
  rename(Subject = `Subject(s)`)
```

# Generate Rmds
## Create the YAML header
```{r}
write_yaml_header <- function(line_of_meta_data){
  yaml_header <- line_of_meta_data %>%  glue_data('
---
title: "{Identifier_popular}"
sanskritTitle: "{Title_sanskrit}"
transliteratedTitle: "{Title_transliteration}"
englishTitle: "{Title_english}"
approximateDating: "{Dating}"
manuscriptLanguage: "{Language}"
script: "{Script}"
material: "{Material}"
condition: "{Condition}"
folios: "{Folios}"
subject: "{Subject}"
physicalLocation: "{Physical_location}"
originPlace: "{Origin_place}"
author: "{Author}"
provenance: "{Provenance}"
bibliographyNote: "{Bibliography}"
codices: "{Codices}"
transliterators: "{Transliterated_by}"
translators: "{Translators}"
googlesheet: "{googlesheet_with_text}"
categories:
  - sanskrit
---

')
  
  write_lines(yaml_header, str_c(here("content", "manuscripts",
                                      str_c(line_of_meta_data$Catalogue_id, ".Rmd"))))  
}

```

## Create the body part
```{r}
write_rmd_w_photos_and_text <- function(line_of_meta_data){
  line_of_meta_data %>%  glue_data('
\`\`\`{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(DT)
library(here)
source(here("_scripts", "manuscript_layout.R"))

photos_folder <- here("static", "manuscripts", "images", "{{Catalogue_id}}", "for_manuscript_page")

folder_name <- "{{Catalogue_id}}/for_manuscript_page/"

photo_info <- tibble(
   photoid = list.files(photos_folder),
   zoomid = str_c("result", photoid),
   photo_path = str_c("/manuscripts/images/", folder_name, list.files(photos_folder)))
data_text <- read_csv(here("static", "manuscripts", "{{Catalogue_id}}.csv")) %>% 
   mutate(photo = str_c(photo, "{{website_photo_extension}}"))
\`\`\`

\`\`\`{r add-text, results="asis"}
pwalk(photo_info, create_content)
cat("\\n")
initiate_zoom_effect(photo_info)
\`\`\`
', .open = "{{", .close = "}}")
}

write_rmd_photos_only <- function(line_of_meta_data){
  line_of_meta_data %>%  glue_data('
\`\`\`{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(DT)
library(here)
source(here("_scripts", "manuscript_layout_photos_only.R"))

photos_folder <- here("static", "manuscripts", "images", "{{Catalogue_id}}", "for_manuscript_page")

folder_name <- "{{Catalogue_id}}/for_manuscript_page/"

photo_info <- tibble(
   photoid = list.files(photos_folder),
   zoomid = str_c("result", photoid),
   photo_path = str_c("/manuscripts/images/", folder_name, list.files(photos_folder)))

data_text <- NA

\`\`\`

\`\`\`{r add-text, results="asis"}
pwalk(photo_info, create_content)
cat("\\n")
initiate_zoom_effect(photo_info)
\`\`\`
', .open = "{{", .close = "}}")
}

write_rmd_text_only <- function(line_of_meta_data){
  line_of_meta_data %>%  glue_data('
\`\`\`{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(DT)
library(here)
source(here("_scripts", "manuscript_layout_text_only.R"))

data_text <- read_csv(here("static", "manuscripts", "{{Catalogue_id}}.csv"))

\`\`\`

\`\`\`{r add-text, results="asis"}
create_content()
cat("\\n")
\`\`\`
', .open = "{{", .close = "}}")
}

write_rmd <- function(line_of_meta_data){
  
  if (line_of_meta_data$has_photos == "yes" & line_of_meta_data$has_text == "yes") {
    print("photos and text")
    rmd_to_write <- write_rmd_w_photos_and_text(line_of_meta_data)  
  } else if (line_of_meta_data$has_photos == "yes" & line_of_meta_data$has_text == "no") {
    print("photos only")
    rmd_to_write <- write_rmd_photos_only(line_of_meta_data)  
  } else if (line_of_meta_data$has_photos == "no" & line_of_meta_data$has_text == "yes") {
    print("text only")
    rmd_to_write <- write_rmd_text_only(line_of_meta_data)  
  }

  write_lines(rmd_to_write, str_c(here("content", "manuscripts", str_c(line_of_meta_data$Catalogue_id, ".Rmd"))), append = TRUE)
  
}

```



Ok, let's try it out

```{r}
generate_rmd <- function(text_with_meta){
  write_yaml_header(text_with_meta)
  write_rmd(text_with_meta)
}

files_to_generate <- text_meta %>% 
  filter(has_content == "yes")

for(i in 1:nrow(files_to_generate)) {
  files_to_generate %>% 
    slice(i) %>% 
    generate_rmd()
}

```

