---
output: html_document
---

# Grab meta data
```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(tidyverse)
library(here)
library(glue)

text_meta <- read_csv(here("static", "manuscripts", "manuscript_meta.csv")) %>% 
  rename(Subject = `Subject(s)`)
```

# Generate Rmds
## Create the YAML header
```{r}
write_yaml_header <- function(line_of_meta_data){
  line_of_meta_data %>%  glue_data('
---
exclude_jquery: true
catalogueId: {Catalogue_id}
title: "{Identifier_popular}"
sanskritTitle: "{Title_sanskrit}"
transliteratedTitle: "{Title_transliteration}"
englishTitle: "{Title_english}"
approximateDating: "{Dating}"
manuscriptLanguage: "{Language}"
script: "{Script}"
material: "{Material}"
condition: "{Condition}"
folios: "{Folios}"
subject: "{Subject}"
physicalLocation: "{Physical_location}"
originPlace: "{Origin_place}"
author: "{Author}"
provenance: "{Provenance}"
bibliographyNote: "{Bibliography}"
codices: "{Codices}"
transliterators: "{Transliterated_by}"
translationEnglish: "{Translation_english_by}"
translationDanish: "{Translation_danish_by}"
googlesheet: "{googlesheet_with_text}"
hasPhotos: {has_photos}
hasText: {has_text}
categories:
  - sanskrit
---

', .na = "")

}

write_yaml_header_text_only_version <- function(line_of_meta_data){
  line_of_meta_data %>%  glue_data('
---
exclude_jquery: true
catalogueId: {Catalogue_id}
title: "{Identifier_popular}"
sanskritTitle: "{Title_sanskrit}"
transliteratedTitle: "{Title_transliteration}"
englishTitle: "{Title_english}"
approximateDating: "{Dating}"
manuscriptLanguage: "{Language}"
script: "{Script}"
material: "{Material}"
condition: "{Condition}"
folios: "{Folios}"
subject: "{Subject}"
physicalLocation: "{Physical_location}"
originPlace: "{Origin_place}"
author: "{Author}"
provenance: "{Provenance}"
bibliographyNote: "{Bibliography}"
codices: "{Codices}"
transliterators: "{Transliterated_by}"
translationEnglish: "{Translation_english_by}"
translationDanish: "{Translation_danish_by}"
googlesheet: "{googlesheet_with_text}"
hasPhotos: {has_photos}
hasText: {has_text}
textOnlyVersion: yes
categories:
  - sanskrit
---

', .na = "")

}

```

## Create the body part
```{r}
write_rmd_w_photos_and_text <- function(line_of_meta_data){
  line_of_meta_data %>%  glue_data('
\`\`\`{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(DT)
library(here)
library(glue)
source(here("_scripts", "manuscript_layout.R"))

photos_folder <- here("static", "manuscripts", "images", "{{Catalogue_id}}", "for_manuscript_page")

folder_name <- "{{Catalogue_id}}/for_manuscript_page/"

data_text <- read_csv(here("static", "manuscripts", "{{Catalogue_id}}.csv")) %>% 
   mutate(photo = str_c(photo, "{{website_photo_extension}}")) %>% 
   mutate(across(-photo, ~ str_c("<div contenteditable>", ., "</div>")))

# count columns to include
count_cols <- data_text %>% 
  slice(1) %>% 
  select(-photo)

cols_include <- count_cols %>% 
  select(chapter, transliteration, starts_with("translation_")) %>% 
  length()

cols_total <- length(count_cols)

cols_hide_nums <- c(1, seq(cols_include + 1, cols_total - 1))

photo_info <- tibble(
   photoid = list.files(photos_folder),
   photo_path = str_c("/manuscripts/images/", folder_name, list.files(photos_folder))) %>%
   mutate(zoomid = str_c("zoomable", row_number()))

# ensure the DT libraries are included - they are not automatically when looping through datatables
datatable(data_text, extensions = c("ColReorder", "Buttons"))
    
\`\`\`

\`\`\`{r add-text, results="asis"}
create_overlay_divs(photo_info)
pwalk(photo_info, create_content, cols_hide = cols_hide_nums)
cat("\\n")
initiate_zoom_effect(photo_info)
create_overlay_functions(photo_info)
\`\`\`
', .open = "{{", .close = "}}")
}

write_rmd_photos_only <- function(line_of_meta_data){
  line_of_meta_data %>%  glue_data('
\`\`\`{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(DT)
library(here)
library(glue)
source(here("_scripts", "manuscript_layout_photos_only.R"))

photos_folder <- here("static", "manuscripts", "images", "{{Catalogue_id}}", "for_manuscript_page")

folder_name <- "{{Catalogue_id}}/for_manuscript_page/"

photo_info <- tibble(
   photoid = list.files(photos_folder),
   photo_path = str_c("/manuscripts/images/", folder_name, list.files(photos_folder))) %>% 
   mutate(zoomid = str_c("zoomable", row_number()))

data_text <- NA

\`\`\`

\`\`\`{r add-text, results="asis"}
create_overlay_divs(photo_info)
pwalk(photo_info, create_content)
cat("\\n")
initiate_zoom_effect(photo_info)
create_overlay_functions(photo_info)
\`\`\`
', .open = "{{", .close = "}}")
}

write_rmd_text_only <- function(line_of_meta_data, text_only_version){
  glue('
\`\`\`{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(DT)
library(here)
source(here("_scripts", "manuscript_layout_text_only.R"))

data_text <- read_csv(here("static", "manuscripts", "{{line_of_meta_data$Catalogue_id}}.csv")) %>% 
  mutate(chapter = as.integer(chapter))

# count columns to include
count_cols <- data_text %>% 
  slice(1)

cols_include <- count_cols %>% 
  select(chapter, transliteration, starts_with("translation_")) %>% 
  length()

cols_total <- length(count_cols)

cols_hide_nums <- c(1, seq(cols_include + 1, cols_total - 1))

# ensure the DT libraries are included - they are not automatically when looping through datatables
datatable(data_text, extensions = c("ColReorder", "Buttons"), filter = "top")

\`\`\`

\`\`\`{r add-text, results="asis"}
create_content(cols_hide = cols_hide_nums, {{text_only_version}})
cat("\\n")
\`\`\`
', .open = "{{", .close = "}}")
}

write_rmd <- function(line_of_meta_data){
  
  if (line_of_meta_data$has_photos == "yes" & line_of_meta_data$has_text == "yes") {
    print("photos and text")
    #write normal version
    yaml_to_write <- write_yaml_header(line_of_meta_data)
    write_lines(yaml_to_write, str_c(here("content", "manuscripts",
                                      str_c(line_of_meta_data$Catalogue_id, ".Rmd"))))  
    rmd_to_write <- write_rmd_w_photos_and_text(line_of_meta_data)
    
    # write text-only version
    yaml_to_write_text_version <- write_yaml_header_text_only_version(line_of_meta_data)
    write_lines(yaml_to_write_text_version, str_c(here("content", "manuscripts",
                                      str_c(line_of_meta_data$Catalogue_id, "-text-only.Rmd"))))
    rmd_to_write_text_version <- write_rmd_text_only(line_of_meta_data, text_only_version = TRUE)  
    write_lines(rmd_to_write_text_version, str_c(here("content", "manuscripts", str_c(line_of_meta_data$Catalogue_id, "-text-only.Rmd"))), append = TRUE)
  } else if (line_of_meta_data$has_photos == "yes" & line_of_meta_data$has_text == "no") {
    print("photos only")
    yaml_to_write <- write_yaml_header(line_of_meta_data)
    write_lines(yaml_to_write, str_c(here("content", "manuscripts",
                                      str_c(line_of_meta_data$Catalogue_id, ".Rmd"))))  
    rmd_to_write <- write_rmd_photos_only(line_of_meta_data)  
  } else if (line_of_meta_data$has_photos == "no" & line_of_meta_data$has_text == "yes") {
    print("text only")
    yaml_to_write <- write_yaml_header(line_of_meta_data)
    write_lines(yaml_to_write, str_c(here("content", "manuscripts",
                                      str_c(line_of_meta_data$Catalogue_id, ".Rmd"))))  
    rmd_to_write <- write_rmd_text_only(line_of_meta_data, text_only_version = FALSE)  
  }
  # append body rmd to yaml
  write_lines(rmd_to_write, str_c(here("content", "manuscripts", str_c(line_of_meta_data$Catalogue_id, ".Rmd"))), append = TRUE)
  
}

```



Ok, let's try it out

```{r}
generate_rmd <- function(text_with_meta){
  write_rmd(text_with_meta)
}

files_to_generate <- text_meta %>% 
  filter(has_content == "yes")

for(i in 1:nrow(files_to_generate)) {
  files_to_generate %>% 
    slice(i) %>% 
    generate_rmd()
}

```

